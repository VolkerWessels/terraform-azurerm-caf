{
  "builders" : [{
    "type": "azure-arm",
    
    "client_id": "${client_id}",
    "client_secret": "${client_secret}",
    "tenant_id": "${tenant_id}",
    "subscription_id": "${subscription_id}",
    
    "os_type": "${os_type}",
    "image_publisher": "${image_publisher}",
    "image_offer": "${image_offer}",
    "image_sku": "${image_sku}",
    
    "location": "${location}",
    "vm_size": "${vm_size}",
    
    "managed_image_resource_group_name": "${managed_image_resource_group_name}",
    "managed_image_name": "${managed_image_name}",
    
    "shared_image_gallery_destination": {
      "subscription": "${subscription_id}",
      "resource_group": "${resource_group}",
      "gallery_name": "${gallery_name}",
      "image_name": "${image_name}",
      "image_version": "${image_version}",
      "replication_regions": "${replication_regions}"
    },
    
    "communicator": "winrm",
    "winrm_use_ssl": true,
    "winrm_insecure": true,
    "winrm_timeout": "5m",
    "winrm_username": "packer",
    "async_resourcegroup_delete": "true",
    "azure_tags": {
      "Product": "Business Central",
      "Afdeling": "ITBV"
    },

    "user_assigned_managed_identities": ["${ansible_playbook_path}"]
  }
],
"provisioners": [
  {
    "type": "powershell",
    "inline": [
      "Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))",
      "Install-PackageProvider nuget -force",
      "Set-PSRepository -name PSGallery -InstallationPolicy Trusted"
    ]
  },
  {
    "type": "powershell",
    "inline": [
      "choco install az.powershell -y -r"
    ]
  }, 
  {
    "type": "powershell",
    "valid_exit_codes": [
      0,
      3010
    ],
    "inline": [
      "install-module az.resourcegraph",
      "choco install dotnetfx -y -r"
    ]
  },
  {
    "type": "windows-restart",
    "restart_check_command": "powershell -command \"& {Write-Output 'restarted.'}\""
    },  
    {
      "type": "powershell",
      "script": "//__w//business-central-landing-zones//business-central-landing-zones//configuration//BC//level3//image_build//packer_files//install-jumphost.ps1"
    },
    {
      "type": "powershell",
      "script": "//__w//business-central-landing-zones//business-central-landing-zones//configuration//BC//level3//image_build//packer_files//finalize.ps1"
    }
  ]
}
